# Azure SRE Agent 検証用 Container Apps Chaos Lab Requirements

## 概要
このドキュメントは、Azure SRE Agentの機能を検証するための環境構築要件を定義します。Container Apps上でアプリケーションを実行し、擬似障害を注入してSRE Agentの動作を確認します。

## プロジェクトの目的
Azure SRE Agentの自動検出・診断・対応機能を検証する。

## 更新履歴
- 2025-07-25: 初版作成
- 2025-07-28: 実装状況の確認と要件の検証
- 2025-07-30: Redis接続リセットAPI要件追加（REQ-010）
- 2025-07-30: Container Apps応答監視アラート要件追加（REQ-017）
- 2025-08-01: Container App upsert戦略要件追加（REQ-018-021）

## 機能要件

### インフラストラクチャ要件

#### REQ-001: Azureリソース
システムは常に以下のAzureリソースを含むものとする：
- Container Apps Environment（VNet統合）
- Container App（サンプルアプリケーション）
- Log Analytics Workspace（パブリックアクセス許可）
- Application Insights（パブリックアクセス許可）
- Azure Managed Redis（Entra ID認証有効）

#### REQ-002: ネットワーク構成
システムは常に以下のネットワーク構成を実装するものとする：
- 仮想ネットワーク（VNet）
- Container Apps用のサブネット
- プライベートエンドポイント用のサブネット
- Azure Managed Redisのプライベートエンドポイント
- インターネットからアクセス可能なHTTPSエンドポイント（Container Apps Ingress）

#### REQ-003: ネットワークセキュリティ
システムは常に以下のセキュリティ設定を含むものとする：
- Container Appsサブネットに適用されるネットワークセキュリティグループ（NSG）
- 通常時はAzure Managed Redisへの通信を許可
- 必要最小限のインバウンド通信のみ許可

### アプリケーション要件

#### REQ-004: サンプルアプリケーション
システムは常に以下の特徴を持つPythonアプリケーションを含むものとする：
- HTTPエンドポイントを公開（FastAPIまたはFlask）
- Azure Managed RedisをEntra ID認証で使用してデータを読み書き
- 正常動作時は200 OKを返す
- Redisへの接続状態を含むヘルスチェックエンドポイント
- メトリクスとログを出力

#### REQ-005: 監視設定
アプリケーションが起動したとき、システムは以下の監視データを生成するものとする：
- Application Insightsへのテレメトリ送信
- Container Appsのシステムログ
- Redisへの接続状態を含むカスタムメトリクス

### 障害注入要件

#### REQ-006: Redis接続障害
障害注入が要求されたとき、システムは以下を実行するものとする：
- NSGルールを動的に更新してRedisへの通信を拒否
- アプリケーションがRedis接続エラーを検出
- エラーログとメトリクスが生成される

#### REQ-007: 過負荷シミュレーション
過負荷テストが要求されたとき、システムは以下の負荷シナリオを実行するものとする：
- アプリケーション内部での負荷生成：
  - 高CPU負荷（計算集約的な処理の実行）
  - 高メモリ負荷（大量のメモリ確保）
  - レスポンス遅延の意図的な追加
- 外部からのリクエスト負荷：
  - Locustを使用した段階的なリクエスト数増加
  - 同時接続数の増加によるコネクション負荷
  - スパイクトラフィックの生成

#### REQ-008: 不正なコンテナイメージデプロイ
デプロイ障害テストが要求されたとき、システムは以下のシナリオを実行するものとする：
- 存在しないコンテナイメージの指定
- 誤ったタグのコンテナイメージの指定
- アクセス権限のないプライベートレジストリのイメージ指定
- Container Appのリビジョン更新による障害注入

#### REQ-009: アプリケーションハングアップ
ハングアップテストが要求されたとき、システムは以下を実行するものとする：
- 専用のハングアップAPIエンドポイント（/chaos/hang）を提供
- APIが呼び出されたとき、そのリクエストのみがハングし、レスポンスを返さずに待機
- 他のAPIエンドポイント（ヘルスチェック、ステータス確認等）は引き続き正常に応答
- 設定可能なハングアップ時間：
  - 時限的ハング：指定秒数後に`{"status": "hang_completed"}`を返す
  - 永続的ハング（duration_seconds: 0）：レスポンスを返さない
- ハング中でもアプリケーション全体は動作を継続（非同期処理により他のリクエストは影響を受けない）

#### REQ-010: Redis接続リセット
Redis接続リセットが要求されたとき、システムは以下を実行するものとする：
- 専用のRedis接続リセットAPIエンドポイントを提供
- APIが呼び出されたとき、既存のRedis接続をすべて切断
- 次回のRedis操作時に新しい接続を自動的に確立
- 接続リセット操作の成功/失敗を報告
- 現在の接続状態をステータスAPIで確認可能

#### REQ-011: 障害の制御
ユーザーが障害を制御するとき、システムは以下を提供するものとする：
- NSGルールの追加/削除によるRedis接続障害の開始/停止
- アプリケーション内部の負荷レベルの動的な調整（低/中/高）
- Locustによる外部負荷の開始/停止と強度調整
- コンテナイメージの更新によるデプロイ障害の注入
- ハングアップAPIの呼び出しによる応答停止
- Redis接続リセットAPIの呼び出しによる接続切断
- 複数の障害シナリオの同時実行
- 現在のシステム状態の確認

### 運用要件

#### REQ-012: デプロイメント
システムは常に以下の方法でデプロイ可能であるものとする：
- Infrastructure as Code（Bicep）によるリソース定義
- Azure Developer CLI (azd) による環境管理とデプロイメント自動化
- 環境変数による設定のパラメータ化

#### REQ-013: 環境管理
Azure Developer CLIを使用するとき、システムは以下を提供するものとする：
- azure.yaml による環境定義
- 複数環境（dev、staging、prod）のサポート
- 環境固有のパラメータ管理
- ワンコマンドでのプロビジョニングとデプロイ

#### REQ-014: 障害注入の自動化
障害注入操作が要求されたとき、システムは以下を提供するものとする：
- Azure CLIスクリプトによるNSGルール操作
- HTTPエンドポイント経由でのアプリケーション内部負荷レベル制御
- Locustの起動/停止スクリプトによる外部負荷制御
- HTTPエンドポイント経由でのハングアップ制御
- HTTPエンドポイント経由でのRedis接続リセット制御
- Azure CLIによるContainer Appリビジョン更新
- 障害注入と復旧の自動化スクリプト

#### REQ-015: 負荷テスト環境
負荷テストが要求されたとき、システムは以下を提供するものとする：
- Locust用のテストシナリオ定義ファイル
- 段階的な負荷増加シナリオ
- スパイク負荷シナリオ
- 長時間持続負荷シナリオ

#### REQ-016: ドキュメント
システムは常に以下を提供するものとする：
- Azure Developer CLIを使用したデプロイ手順
- 障害注入方法（NSGルール操作、負荷制御API、ハングアップAPI、Redis接続リセットAPI、リビジョン更新）
- Locustを使用した負荷テスト実行手順
- SRE Agent設定手順

### 監視要件

#### REQ-017: Container Apps応答監視アラート
Container Appsが異常な応答をしたとき、システムは以下のアラートを発生するものとする：
- 5分間の5XXエラー率が1%を超えた場合のアラート
- 5分間の平均応答時間が5秒を超えた場合のアラート
- Azure MonitorアクショングループでのEmail通知設定

### デプロイメント要件

#### REQ-018: Container App Upsert戦略
システムは常にAzure Verified Moduleの`container-app-upsert`パターンを使用してContainer Appsをデプロイするものとする

#### REQ-019: インクリメンタル更新  
新しいコンテナイメージが指定されたとき、システムは既存のContainer Appを完全に置換せずに更新するものとする

#### REQ-020: 設定保持
Container App更新が実行されたとき、システムは明示的に変更されない設定値を保持するものとする

#### REQ-021: 条件付きイメージ更新
コンテナイメージが指定されていない場合、システムは既存のコンテナイメージを保持するものとする

## 制約事項

### 技術的制約

#### CON-001: Azure Container Apps
システムは常にAzure Container Apps上で動作するものとする

#### CON-002: プログラミング言語
サンプルアプリケーションはPythonで実装するものとする

#### CON-006: Redis認証
Azure Managed RedisへのアクセスはEntra ID認証を使用し、パスワード認証は使用しないものとする

#### CON-003: 監視サービスのアクセス
Log AnalyticsとApplication Insightsのプライベートエンドポイント化は複雑なため、パブリックアクセスを許可するものとする

#### CON-004: CLI ツール
システムの管理にはAzure CLIを使用し、Azure PowerShellは使用しないものとする

#### CON-005: JSON処理ツール
スクリプトでのJSON操作にはjqツールを使用し、Azure CLIの出力解析や設定ファイルの操作を行うものとする

#### CON-006: 負荷テストツール
負荷生成はLocustを使用し、ローカル環境から実行するものとする

## 受け入れ基準

### AC-001: 基本動作
- 正常時：アプリケーションがRedisにアクセスでき、200 OKを返す
- Redis障害時：NSGルールによりRedis接続が失敗し、適切なエラーを返す
- アプリケーション内部負荷時：CPU/メモリ使用率が上昇し、レスポンスが遅延する
- 外部負荷時：Locustによる大量リクエストでレスポンス時間が劣化し、場合によってはタイムアウトが発生する
- デプロイ障害時：Container Appが新しいリビジョンの作成に失敗する
- ハングアップ時：ハングAPIを呼び出したリクエストのみがレスポンスを返さず、他のエンドポイントは正常に応答
- 復旧時：すべての障害除去後、正常状態に戻る

### AC-002: ネットワーク要件
- Container AppsとRedisがプライベートエンドポイント経由で通信する
- NSGルールの動的な追加・削除が可能
- 外部からはContainer Apps Ingressのみアクセス可能

### AC-003: デプロイメント
- Azure Developer CLIで `azd up` コマンド1つで全環境をデプロイできる
- `azd env` で複数環境を管理できる
- デプロイ後すぐに動作確認ができる
- `azd down` で環境を簡単に削除できる

### AC-004: 負荷テスト
- Locustでシナリオベースの負荷テストを実行できる
- 負荷テスト中のメトリクスがApplication Insightsで確認できる
- 異なる負荷パターンを簡単に切り替えられる

## 技術的決定事項

### 決定 - 2025-07-25
**決定**: Azure Managed Redisを依存サービスとして採用
**根拠**: 一般的なマイクロサービスアーキテクチャで使用される外部依存を再現
**影響**: アプリケーションの複雑度が上がるが、より現実的な障害シナリオを実現

### 決定 - 2025-07-25
**決定**: NSGルールによる動的な通信制御で障害を注入
**根拠**: 実際の運用で発生しうるネットワーク障害を正確に再現可能
**影響**: 障害注入の実装がシンプルで、影響範囲を明確に制御できる

### 決定 - 2025-07-25
**決定**: プライベートエンドポイント経由でのRedis接続
**根拠**: セキュリティベストプラクティスに従い、プライベート通信を実現
**影響**: より本番環境に近い構成での検証が可能

### 決定 - 2025-07-25
**決定**: アプリケーション内での過負荷シミュレーション
**根拠**: SRE Agentのスケーリング対応やパフォーマンス問題の検出能力を検証
**影響**: より包括的なSRE Agent機能の検証が可能

### 決定 - 2025-07-25
**決定**: Container Appリビジョン更新によるデプロイ障害シミュレーション
**根拠**: 実際の運用で頻繁に発生するデプロイ関連の問題を再現
**影響**: SRE Agentのデプロイ失敗対応能力を検証可能

### 決定 - 2025-07-25
**決定**: アプリケーション内でのハングアップAPIの実装
**根拠**: アプリケーションの無応答状態に対するSRE Agentの検出・復旧能力を検証
**影響**: ヘルスチェック失敗やタイムアウト検出のシナリオを正確に再現可能

### 決定 - 2025-07-25
**決定**: Azure Developer CLIによる環境管理
**根拠**: モダンな開発ワークフローの採用と、環境管理の簡素化
**影響**: 開発者体験の向上と、CI/CDパイプラインとの統合が容易

### 決定 - 2025-07-25
**決定**: Pythonアプリケーションとlocustによる負荷テスト
**根拠**: Pythonエコシステムの成熟度と、locustの柔軟なシナリオ定義能力
**影響**: 統一された言語環境により、開発と負荷テストの連携が容易

## 信頼度評価

**信頼度スコア: 98%**

**根拠:**
- 目的が明確でスコープが限定的
- NSGルールによる通信制御は確実に動作する
- Container AppsとRedisのプライベートエンドポイント統合は成熟した機能
- Pythonでの実装は豊富なライブラリとドキュメントが利用可能
- Locustは実績のある負荷テストツール
- Container Appsのリビジョン管理機能は安定している
- ハングアップAPIの実装は単純で確実に動作する
- Azure Developer CLIはContainer Appsを公式サポート
- 必要なAzureサービスはすべて利用可能
- **2025-07-28更新**: 実装がほぼ完了し、テスト済みであることを確認

**推奨アプローチ:**
高信頼度のため、標準的な実装アプローチで進める。まずAzure Developer CLI環境を設定し、ネットワークインフラストラクチャとRedisをBicepで定義、Container Apps環境を構築、Redisを使用するPython Webアプリケーションを実装して、NSGルール操作による障害注入機能、過負荷シミュレーション機能、リビジョン更新による障害注入機能、およびハングアップAPI機能を追加する。並行してLocustテストシナリオを開発する。

## 実装状況（2025-07-30確認）

### 完了済み要件
- ✅ REQ-001: Azureリソース - すべてのリソースがBicepで定義済み
- ✅ REQ-002: ネットワーク構成 - VNet、サブネット、プライベートエンドポイント実装済み
- ✅ REQ-003: ネットワークセキュリティ - NSGと動的ルール管理実装済み
- ✅ REQ-004: サンプルアプリケーション - FastAPIアプリケーション実装済み
- ✅ REQ-005: 監視設定 - Application InsightsとOpenTelemetry統合済み
- ✅ REQ-006: Redis接続障害 - NSGルール操作スクリプト実装済み
- ✅ REQ-007: 過負荷シミュレーション - アプリ内負荷生成とLocustシナリオ実装済み
- ✅ REQ-008: 不正なコンテナイメージデプロイ - デプロイ障害注入スクリプト実装済み
- ✅ REQ-009: アプリケーションハングアップ - ハングアップAPI実装済み
- ✅ REQ-010: Redis接続リセット - Redis接続リセットAPI実装済み
- ✅ REQ-011: 障害の制御 - すべての障害制御機能実装済み
- ✅ REQ-012: デプロイメント - Bicep、azd設定完了
- ✅ REQ-013: 環境管理 - azure.yamlによる環境定義済み
- ✅ REQ-014: 障害注入の自動化 - すべてのスクリプト実装済み
- ✅ REQ-015: 負荷テスト環境 - Locustシナリオ実装済み
- ✅ REQ-016: ドキュメント - README.mdとドキュメント完備
- ✅ REQ-017: Container Apps応答監視アラート - alert-rules.bicepモジュールで実装済み

### 新規要件（2025-08-01追加）
- ✅ REQ-018: Container App upsert戦略 - Azure Verified Module (br/public:avm/ptn/azd/container-app-upsert:0.1.2) 導入完了
- ✅ REQ-019: インクリメンタル更新 - upsert戦略による条件付き更新実装完了
- ✅ REQ-020: 設定保持 - AVMモジュールによる既存設定保持実装完了
- ✅ REQ-021: 条件付きイメージ更新 - `!empty(containerAppImageName)`による条件分岐実装完了

### 残作業
すべての要件が完了しました。
