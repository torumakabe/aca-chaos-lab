# テレメトリサンプリング機能追加 - 実装記録

**実装日**: 2025年8月3日  
**目的**: 大量テレメトリによるコスト増加を防ぐサンプリング機能追加

## 背景

負荷試験において大量のテレメトリデータが送信されることが判明し、Azure Application Insightsのコスト増加が懸念されました。特に高頻度で実行されるChaos操作において、毎回メトリクスを送信することでコストが急増する可能性があります。

## 実装内容

### ✅ REQ-TEL-004: テレメトリサンプリング要件追加

#### 要件仕様更新
**ファイル**: `docs/requirements.md`
- サンプリング率制御要件を明文化
- デフォルト10%送信、環境変数での設定変更可能
- エラー系は常に100%送信を保証
- 0.0〜1.0の範囲での設定可能

#### 設定拡張
**ファイル**: `src/app/config.py`
```python
telemetry_sampling_rate: float = float(os.getenv("TELEMETRY_SAMPLING_RATE", "0.1"))
```
- 環境変数 `TELEMETRY_SAMPLING_RATE` による制御
- デフォルト値: 0.1（10%）

#### サンプリング機能実装
**ファイル**: `src/app/telemetry.py`

**新機能:**
- `_should_sample_metrics()`: サンプリング判定関数
- 確率的サンプリング（random.random()使用）
- 設定値による動的制御

**適用箇所:**
1. **Redis メトリクス** (`record_redis_metrics`)
   - 成功時: サンプリング適用
   - エラー時（disconnected）: 常に送信

2. **Chaos メトリクス** (`record_chaos_metrics`)  
   - 操作開始時: サンプリング適用
   - 操作終了時: 常に送信（重要指標のため）

#### テストケース追加
**ファイル**: `src/tests/unit/test_telemetry.py`

**新テストクラス**: `TestSampling`（6個のテストケース）
- サンプリング判定ロジックの動作確認
- 0%、10%、100%での動作検証
- Redis/Chaosメトリクスでのサンプリング適用確認
- エラー時の常時送信確認

**既存テスト修正**: 
- サンプリング率設定追加（`telemetry_sampling_rate = 1.0`）
- 全テストで確実に実行されるよう調整

## パフォーマンス影響

### コスト削減効果
- **通常運用**: 90%のテレメトリ削減（10%サンプリング）
- **負荷試験**: 大幅なコスト抑制効果
- **エラー時**: 重要な障害情報は確実に送信

### 計算時間オーバーヘッド
- `random.random()` 呼び出し: <0.1ms
- 条件判定処理: <0.1ms
- 既存の1ms目標に影響なし

## 設定例

### 開発環境（詳細監視）
```bash
export TELEMETRY_SAMPLING_RATE=1.0  # 100%送信
```

### 本番環境（コスト重視）
```bash
export TELEMETRY_SAMPLING_RATE=0.1  # 10%送信（デフォルト）
```

### 負荷試験環境（最小限）
```bash
export TELEMETRY_SAMPLING_RATE=0.01  # 1%送信
```

### テレメトリ無効化
```bash
export TELEMETRY_SAMPLING_RATE=0.0  # 0%送信
```

## 検証結果

### テスト結果
- **総テスト数**: 57個（6個増加）
- **成功率**: 100%
- **新サンプリングテスト**: 6個すべて成功

### コード品質
- **Ruff format**: 問題なし
- **Ruff linting**: app/ディレクトリでエラーゼロ
- **型チェック**: エラーなし

## 今後の運用

### 監視ポイント
1. **Application Insightsコスト**: サンプリング前後の比較
2. **重要エラー**: 漏れなく記録されることの確認
3. **サンプリング率**: 環境に応じた最適値の調整

### 調整指針
- **開発時**: 100%（詳細デバッグ用）
- **本番運用**: 10%（標準）
- **負荷試験**: 1-5%（コスト最適化）
- **緊急時**: 100%（問題調査用）

## 結論

テレメトリサンプリング機能により、コストと可観測性のバランスを実現しました。重要な障害情報は確実に収集しつつ、日常的なメトリクスは効率的に削減できます。
