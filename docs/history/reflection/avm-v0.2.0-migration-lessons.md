# AVM v0.2.0移行プロジェクト - 学習事項とベストプラクティス

## プロジェクト概要

- **プロジェクト名**: Azure Verified Module (AVM) container-app-upsert v0.2.0移行
- **実施期間**: 2025年8月14日
- **目的**: AVM v0.2.0のcontainerProbesパラメータサポートを活用し、外部スクリプト依存を排除
- **成果**: postprovisionフック削除、Bicep内でのヘルスプローブ完全管理実現

## 主要学習事項

### 1. AVM モジュール バージョンアップグレード手順

#### 破壊的変更の特定プロセス
- **事前調査の重要性**: GitHubリポジトリでの実装例確認が不可欠
- **パラメータ形式変更**: `secrets` パラメータが `object` から `array` 形式に変更
- **型安全性**: Bicepの型チェックが破壊的変更を早期検出

#### 実践的対応方法
```bicep
// v0.1.2 (旧形式)
secrets: {
  secureList: [
    {
      name: 'redis-connection-string'
      value: redisConnectionString
    }
  ]
}

// v0.2.0 (新形式) 
secrets: [
  {
    name: 'redis-connection-string'
    value: redisConnectionString
  }
]
```

### 2. Infrastructure as Code ベストプラクティス

#### 宣言的インフラ管理の利点
- **一元管理**: すべてのリソース設定をBicepテンプレートで管理
- **冪等性**: 何度実行しても同じ結果を保証
- **可視性**: インフラ設定がコードとして可読

#### postprovisionフック削除による利点
- **デプロイ時間短縮**: 4分46秒で完了（フック処理時間削除）
- **複雑性削減**: スクリプト実行順序の考慮が不要
- **エラー削減**: 外部スクリプト依存によるタイミング問題の解消

### 3. ヘルスプローブ設定のベストプラクティス

#### ADR仕様の厳密な実装
```bicep
containerProbes: [
  {
    type: 'Liveness'
    transport: 'TCP'
    port: 8000
    initialDelaySeconds: 60
    periodSeconds: 10
  }
  {
    type: 'Readiness'
    transport: 'HTTP'
    port: 8000
    path: '/health'
    initialDelaySeconds: 10
    periodSeconds: 5
  }
]
```

#### 設定検証の重要性
- Azure CLI による設定確認の自動化
- エンドポイントテストによる実効性検証
- ADR仕様との厳密な適合性確認

### 4. デバッグとトラブルシューティング

#### Bicep警告の適切な処理
- BCP081警告: Redis関連の既知の警告への対応
- `#disable-next-line BCP081` による選択的抑制
- 警告の性質理解と適切な判断

#### 段階的検証アプローチ
1. Bicepテンプレート構文チェック
2. Azure リソース デプロイメント
3. アプリケーション レベル 機能確認
4. エンドツーエンド統合テスト

## 技術的成果

### 削除されたファイル
- `scripts/add-health-probes.sh` (127行) - 完全に不要となった
- `azure.yaml` の postprovision セクション - 設定の簡素化

### 強化されたファイル
- `infra/main.bicep`: containerProbesパラメータ統合
- `docs/design.md`: AVM v0.2.0対応設計文書

### 検証された機能
- ✅ Liveness Probe (TCP 8000, 60s初期遅延, 10s間隔)
- ✅ Readiness Probe (HTTP /health, 10s初期遅延, 5s間隔)
- ✅ Redis接続性
- ✅ カオスエンジニアリングAPI
- ✅ 基本ヘルスチェック

## リスク管理

### 識別されたリスク
1. **破壊的変更**: AVM モジュールのパラメータ形式変更
2. **互換性**: 既存アプリケーションコードとの整合性
3. **タイミング**: ヘルスプローブ設定の適用タイミング

### 実装された軽減策
1. **事前検証**: GitHub実装例での形式確認
2. **段階的テスト**: Bicep → デプロイ → 機能確認
3. **完全性確認**: Azure CLIによる設定検証

## 推奨事項

### AVM モジュール更新手順
1. **リリースノート確認**: 破壊的変更の有無を事前確認
2. **実装例調査**: GitHub公式リポジトリでの使用例確認
3. **段階的適用**: 開発環境での十分な検証後に本番適用
4. **設定検証**: Azure CLIやポータルでの設定確認を必須化

### Infrastructure as Code 運用
1. **宣言的管理**: 可能な限りすべてをBicepテンプレートで管理
2. **外部依存最小化**: postprovisionフックの使用を最小限に
3. **検証自動化**: デプロイ後の設定確認を自動化
4. **文書化**: ADRと実装の厳密な対応付け

### プロジェクト管理
1. **仕様駆動**: 6フェーズワークフローの厳密な実行
2. **承認ゲート**: 各フェーズ間での明示的な承認確認
3. **文書管理**: 履歴ドキュメントの体系的保存
4. **学習共有**: プロジェクト完了後の知見共有

## まとめ

AVM v0.2.0移行プロジェクトは、Infrastructure as Codeの価値を実証する成功事例となりました。外部スクリプト依存の排除により、デプロイメントの信頼性と保守性が大幅に向上しました。特に、Bicepテンプレート内でのヘルスプローブ完全管理により、設定の可視性と一貫性が向上したことは大きな成果です。

今後のAVMモジュール更新においても、本プロジェクトで確立された手順とベストプラクティスを適用することで、効率的かつ安全な移行が可能となります。
