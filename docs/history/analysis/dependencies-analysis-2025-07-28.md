### [分析] - [依存関係分析] - [2025-07-28]
**目的**: Azure Container Apps Chaos Labプロジェクトの依存関係と制約を特定し、リスクと緩和戦略を文書化する
**コンテキスト**: 分析フェーズの一環として、システムの依存関係を明確化
**決定**: すべての依存関係を洗い出し、リスクレベルに応じた緩和策を定義
**実行**: インフラ、アプリケーション、外部サービスの依存関係を分析
**出力**: 

## 依存関係グラフ

### インフラストラクチャ依存関係
```
Azure Subscription
├── Resource Group
│   ├── VNet (10.0.0.0/16)
│   │   ├── Container Apps Subnet (10.0.0.0/23)
│   │   │   └── NSG (動的ルール管理)
│   │   └── Private Endpoint Subnet (10.0.2.0/24)
│   │       ├── Redis Private Endpoint
│   │       └── Container Registry Private Endpoint
│   ├── Container Apps Environment
│   │   └── Container App (マネージドアイデンティティ)
│   ├── Azure Managed Redis (Entra ID認証)
│   ├── Container Registry (Premium SKU)
│   ├── Log Analytics Workspace
│   └── Application Insights
└── Entra ID (認証プロバイダー)
```

### アプリケーション依存関係
```
FastAPI Application
├── Azure Identity SDK (Entra ID認証)
├── Redis-py (非同期クライアント)
├── OpenTelemetry (監視)
│   └── Azure Monitor Exporter
├── Pydantic (データモデル)
└── HTTPX (HTTPクライアント)
```

### 開発・運用ツール依存関係
```
開発環境
├── Python 3.13+
├── uv (パッケージマネージャー)
├── Docker (コンテナビルド)
├── Azure Developer CLI (azd)
├── Azure CLI
└── Locust (負荷テスト)
```

## リスク分析と緩和戦略

### 高リスク依存関係

#### 1. Azure Managed Redis (Entra ID認証)
- **リスク**: Entra IDトークンの有効期限切れや認証エラー
- **影響**: アプリケーションがRedisに接続できなくなる
- **緩和策**: 
  - トークンの自動更新メカニズム実装済み
  - 接続エラー時のリトライロジック実装済み
  - REDIS_ENABLED=falseでRedisなしでも動作可能

#### 2. Container Apps Environment
- **リスク**: スケーリング制限やリソース不足
- **影響**: 高負荷時にアプリケーションが応答しなくなる
- **緩和策**: 
  - 最大レプリカ数を10に設定
  - CPU/メモリリソースの適切な設定
  - 自動スケーリングルールの実装

### 中リスク依存関係

#### 3. NSG動的ルール管理
- **リスク**: ルール変更が即座に反映されない
- **影響**: 障害注入/復旧のタイミングがずれる
- **緩和策**: 
  - スクリプトに確認ロジックを追加
  - タイムアウト設定の実装
  - 手動での確認手順をドキュメント化

#### 4. プライベートエンドポイント
- **リスク**: DNS解決の問題
- **影響**: Redisやコンテナレジストリに接続できない
- **緩和策**: 
  - VNet内からのアクセスのみに制限
  - プライベートDNSゾーンの自動設定

### 低リスク依存関係

#### 5. Application Insights
- **リスク**: データ収集の遅延やデータロス
- **影響**: 監視データの一部が欠落
- **緩和策**: 
  - ローカルログも併用
  - バッファリングとリトライの実装

#### 6. Python パッケージ
- **リスク**: バージョン互換性の問題
- **影響**: ビルドエラーや実行時エラー
- **緩和策**: 
  - requirements.txtでバージョン固定
  - 定期的な依存関係更新とテスト

## 制約事項

### 技術的制約
1. **Azure Container Apps**: サーバーレスコンテナプラットフォームの制限
   - 最大レプリカ数: 300
   - 最大同時リクエスト数: 1000/レプリカ
   - 永続ストレージなし

2. **Azure Managed Redis**: 
   - Entra ID認証必須（パスワード認証不可）
   - ポート10000使用（標準の6379ではない）
   - SKU制限によるメモリ上限

3. **ネットワーク制約**:
   - NSGは送信ルールのみサポート
   - プライベートエンドポイントは単方向アクセス

### 運用制約
1. **監視サービス**: パブリックアクセス必須（設計上の制約）
2. **デプロイメント**: Container Registryへのプッシュ権限必要
3. **負荷テスト**: ローカル環境からの実行（Azure内部からは困難）

**検証**: すべての依存関係が特定され、適切な緩和策が実装済み
**次**: データフローと相互作用のマッピング