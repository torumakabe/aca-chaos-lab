# テレメトリとロギング一貫性向上 - 実装記録

**実装日**: 2025年8月3日  
**目的**: OpenTelemetryを活用したテレメトリとロギングの一貫性向上

## 実装決定記録

### 決定 - 2025-08-03
**決定**: OpenTelemetryの自動計装を活用し、カスタムメトリクスとスパンエラー記録を最小限追加する
**コンテキスト**: 過剰な計装を避けつつ、SREエージェント支援に必要な情報を提供する必要があった
**オプション**: 
- 完全カスタム計装（複雑すぎる）
- 自動計装のみ（ビジネスメトリクス不足）
- 自動計装＋最小カスタム（採用）
**根拠**: OpenTelemetryの標準パターンを活用し、保守性と機能性のバランスを取る
**影響**: 実装コストを抑えつつ、必要な可視性を確保
**レビュー**: 3ヶ月後にメトリクスの有用性を評価

### 決定 - 2025-08-03  
**決定**: テレメトリ機能を設定で無効化可能にする
**コンテキスト**: 開発環境やトラブルシューティング時にテレメトリを無効化する必要がある
**オプション**:
- 常時有効（柔軟性なし）
- 設定で制御（採用）
**根拠**: 運用環境での柔軟性と開発時の簡素化を両立
**影響**: 設定管理の複雑化は最小限、運用性が向上
**レビュー**: 設定利用状況を1ヶ月後に確認

## 実装内容サマリー

### ファイル変更一覧
- `src/app/telemetry.py`: ヘルパー関数追加（record_span_error, record_redis_metrics, record_chaos_metrics）
- `src/app/main.py`: 例外ハンドラーにスパンエラー記録追加
- `src/app/redis_client.py`: Redis操作メトリクス記録追加
- `src/app/chaos.py`: カオス操作メトリクス記録追加
- `src/app/config.py`: テレメトリ設定オプション追加
- `src/tests/unit/test_telemetry.py`: 新機能単体テスト追加

### 追加されたメトリクス
- `redis_connection_status`: Redis接続状態 (gauge)
- `redis_connection_latency_ms`: Redis応答時間 (histogram)
- `chaos_operation_active`: アクティブなカオス操作数 (gauge)
- `chaos_operation_duration_seconds`: カオス操作実行時間 (histogram)

### 設定オプション
- `TELEMETRY_ENABLED`: テレメトリ全体の有効/無効
- `CUSTOM_METRICS_ENABLED`: カスタムメトリクスの有効/無効
- `LOG_TELEMETRY_INTEGRATION`: ログ統合の有効/無効

## 品質保証

### 実装品質
- OpenTelemetryの標準パターンに準拠
- エラーハンドリング実装済み
- 設定による無効化対応
- 循環インポート回避

### テストカバレッジ
- 単体テスト実装（test_telemetry.py）
- 主要機能の正常系・異常系テスト
- モック/スタブによる依存関係分離

### パフォーマンス考慮
- メトリクス記録の例外処理でアプリケーション継続保証
- 非同期処理への影響最小化
- テレメトリ無効化時のオーバーヘッドなし
