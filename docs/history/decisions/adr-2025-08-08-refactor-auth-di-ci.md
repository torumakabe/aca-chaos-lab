# ADR: 認証リトライ・DI導入・CI簡素化

- 日付: 2025-08-08
- ステータス: Accepted

## 背景
Azure Managed Redis への Entra ID 認証で、トークン期限切れや一時的な認可エラーによりAPIの可用性が影響するケースがあった。また、テスト容易性と初期化/終了の明確化のため、依存性注入（DI）とライフサイクル管理の改善が必要だった。CIではBicep検証の安定化が課題で、複雑な実装が保守性を下げていた。

## 決定
1. 認証エラー時は1回に限り、トークン再取得→クライアント再構築→ping検証→再実行で自動回復を行う。
2. トークンキャッシュはエポック秒に基づき、有効期限-120秒の安全マージンを適用。
3. FastAPIの `app.state` に設定値と Redis クライアントを保持し、lifespan で初期化/終了を管理。モジュールレベル変数は後方互換のフォールバック。
4. GitHub Actions の Bicep ジョブは、ネイティブCLIで `bicep restore`→`bicep build` のみに簡素化（ログイン不要）。

## 影響
- 可用性: トークン期限切れ等の認証起因エラーでの瞬断を軽減。
- 保守性/テスト容易性: app.state による明確な依存性注入とライフサイクル管理により改善。
- CI 安定性: 余計な依存を排し、標準的な最小構成でビルドを実行。

## トレードオフ
- 認証エラー時の再試行は1回に制限（ループ防止/レイテンシ抑制）。
- 早期失効マージンにより、まれに実効期限より早く更新が発生。

## 代替案
- エラーごとに複数回の再試行（レイテンシ増大/複雑化の懸念のため採用せず）。
- DIフレームワーク導入（規模に対してオーバーキルのため採用せず）。
- DockerベースのBicep実行（依存増と不安定性のため採用せず）。

## フォローアップ
- PR向けのwhat-if検証と、main向けのarm-deployを別ワークフローで導入（OIDC azure/login）。
- Bicep CLI のバージョン更新の自動化（Renovate/Dependabot）。
